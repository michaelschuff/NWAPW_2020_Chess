<!doctype html>
<html>
    <head>
        <title>Chess</title>
        <link rel='stylesheet' type='text/css' href='css/game.css' />
        <script src='/socket.io/socket.io.js'></script>
        <script src='/client/socketFunctions.js'></script>
        <script src='/client/illegalMoveCheck.js'></script>
    </head>
    <body id=body></body>
        
        <div id=accountoptions>
            <p id=currentuser></p>
            <button id=logout onclick=logoutPressed()>Logout</button>
        </div>

        <div id=chessboard>
            <img src='/client/imgs/board.png' id=board>
        </div>
        <script>
            const SSID = document.cookie.split(';').find(row => row.startsWith('sessionID')).split('=')[1];
            
            var fromSquare = '';
            var toSquare = '';
            const alphabet = 'abcdefgh';
            var socket = io();
            var color;
            var myMove = false;
            var board = [
                ['wr','wn','wb','wq','wk','wb','wn','wr'],
                ['wp','wp','wp','wp','wp','wp','wp','wp'],
                ['__','__','__','__','__','__','__','__'],
                ['__','__','__','__','__','__','__','__'],
                ['__','__','__','__','__','__','__','__'],
                ['__','__','__','__','__','__','__','__'],
                ['bp','bp','bp','bp','bp','bp','bp','bp'],
                ['br','bn','bb','bq','bk','bb','bn','br']
            ];


            socket.on('connect', function() {connection_successful(socket);});
            socket.on('reconnect', function() {reconnection_successful(socket);});
            socket.on('connect_error', function() {connection_failed();});
            socket.on('connect_timeout', function() {connection_timeout();});
            socket.on('reconnect_attempt', function() {attempting_reconnection();});
            socket.on('reconnect_error', function() {reconnection_failed();});
            socket.on('validation_success', function(data) {validation_success(data);});
            socket.on('validation_failed', function() {validation_failed()});

            socket.on('redirect', function(path) {redirect(path);});

            function logoutPressed() {
                socket.emit('logout', {sessionID: SSID});
                document.cookie = 'sessionID=; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            }


            
            
            socket.on('make_a_move', function(data) {
                updateboard(data.fro, data.to);
                myMove = true;
                var legalmoves = getLegalMoves(board, 'b', {from: data.fro, to: data.to});
                socket.emit('bigdata', legalmoves);
            });
            
            socket.on('play_game', function(data) {
                color = data.color;
                for (y = 0; y < 8; y++) {
                    var div = document.createElement('div');
                    div.id = 'row' + y;
                    document.getElementById('chessboard').appendChild(div);
                    for (x = 0; x < 8; x++) {
                        var img = document.createElement('img');
                        img.src = '/client/imgs/' + board[y][x].toLowerCase() + '.png';
                        img.className = 'piece';
                        img.id = alphabet[x] + (y + 1).toString();
                        if (color == 'white') {
                            img.style.top = (7-y).toString() + '00px';
                            img.style.left = x.toString() + '00px';
                        } else {
                            img.style.top = y.toString() + '00px';
                            img.style.left = (7-x).toString() + '00px';
                        }
                        
                        img.addEventListener('click', squareClicked, false);
                        document.getElementById('row' + y.toString()).appendChild(img);
                    }
                }
                if (color == 'white') {
                    myMove = true;
                }
            });

            function squareClicked() {
                if (myMove) {
                    if (fromSquare == '') {
                        fromSquare = this.id;
                    } else {
                        toSquare = this.id;
                        updateboard(fromSquare, toSquare);
                        myMove = false;
                        socket.emit(color + '_moved', {to: toSquare, fro: fromSquare, sessionID: SSID});
                        fromSquare = '';
                        toSquare = '';
                    }
                }
            }

            function updateboard(from, to) {
                from = {x: alphabet.indexOf(from[0]), y: parseInt(from[1]) - 1};
                to = {x: alphabet.indexOf(to[0]), y: parseInt(to[1]) - 1};

                var temp = board[from.y][from.x];
                board[from.y][from.x] = board[to.y][to.x];
                board[to.y][to.x] = temp;
                redrawBoard();
            }

            function redrawBoard() {
                if (color == 'white') {
                    for (y = 0; y < 8; y++) {
                        for (x = 0; x < 8; x++) {
                            document.getElementById(alphabet[x] + (y + 1).toString()).src = '/client/imgs/' + board[y][x] + '.png';
                        }
                    }
                } else {
                    for (y = 0; y < 8; y++) {
                        for (x = 0; x < 8; x++) {
                            document.getElementById(alphabet[x] + (y + 1).toString()).src = '/client/imgs/' + board[y][x] + '.png';
                        }
                    }
                }
            }
        </script>
    </body>
</html>